{% extends "base.html" %}

{% block title %}Calendar Mappings - CalDAV Sync Microservice{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-arrow-left-right"></i> Calendar Mappings</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMappingModal">
                <i class="bi bi-plus-circle"></i> Create Mapping
            </button>
        </div>
    </div>
</div>

<!-- Mappings List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list"></i> Your Calendar Mappings</h5>
            </div>
            <div class="card-body">
                <div id="mappings-list">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading mappings...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Mapping Modal -->
<div class="modal fade" id="addMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Calendar Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMappingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>CalDAV Calendar</h6>
                            <div class="mb-3">
                                <label for="caldavAccount" class="form-label">CalDAV Account</label>
                                <select class="form-select" id="caldavAccount" required>
                                    <option value="">Select an account...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="caldavCalendar" class="form-label">CalDAV Calendar</label>
                                <select class="form-select" id="caldavCalendar" required disabled>
                                    <option value="">Select a calendar...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Google Calendar</h6>
                            <div class="mb-3">
                                <label for="googleCalendar" class="form-label">Google Calendar</label>
                                <select class="form-select" id="googleCalendar" required>
                                    <option value="">Select a calendar...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="syncDirection" class="form-label">Sync Direction</label>
                                <select class="form-select" id="syncDirection" required>
                                    <option value="caldav_to_google">CalDAV → Google</option>
                                    <option value="google_to_caldav">Google → CalDAV</option>
                                    <option value="bidirectional">Bidirectional</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="syncInterval" class="form-label">Sync Interval (minutes)</label>
                                <input type="number" class="form-control" id="syncInterval" value="5" min="1" max="1440" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="syncWindow" class="form-label">Sync Window (days)</label>
                                <input type="number" class="form-control" id="syncWindow" value="30" min="1" max="365" required>
                                <div class="form-text">How many days forward to sync</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="webhookUrl" class="form-label">Webhook URL (optional)</label>
                                <input type="url" class="form-control" id="webhookUrl">
                                <div class="form-text">URL to notify when sync completes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="enableMapping" checked>
                        <label class="form-check-label" for="enableMapping">
                            Enable this mapping
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createMapping()">
                    <i class="bi bi-check-circle"></i> Create Mapping
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Calendar Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMappingForm">
                    <input type="hidden" id="editMappingId" name="mappingId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>CalDAV Calendar</h6>
                            <div class="mb-3">
                                <label for="editCaldavAccountName" class="form-label">CalDAV Account</label>
                                <input type="text" class="form-control" id="editCaldavAccountName" readonly>
                                <div class="form-text">Account cannot be changed when editing</div>
                            </div>
                            <div class="mb-3">
                                <label for="editCaldavCalendarName" class="form-label">CalDAV Calendar</label>
                                <input type="text" class="form-control" id="editCaldavCalendarName" readonly>
                                <div class="form-text">Calendar cannot be changed when editing</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Google Calendar</h6>
                            <div class="mb-3">
                                <label for="editGoogleCalendarName" class="form-label">Google Calendar</label>
                                <input type="text" class="form-control" id="editGoogleCalendarName" readonly>
                                <div class="form-text">Calendar cannot be changed when editing</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSyncDirection" class="form-label">Sync Direction</label>
                                <select class="form-select" id="editSyncDirection" required>
                                    <option value="caldav_to_google">CalDAV → Google</option>
                                    <option value="google_to_caldav">Google → CalDAV</option>
                                    <option value="bidirectional">Bidirectional</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSyncInterval" class="form-label">Sync Interval (minutes)</label>
                                <input type="number" class="form-control" id="editSyncInterval" min="1" max="1440" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSyncWindow" class="form-label">Sync Window (days)</label>
                                <input type="number" class="form-control" id="editSyncWindow" min="1" max="365" required>
                                <div class="form-text">How many days forward to sync</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWebhookUrl" class="form-label">Webhook URL (optional)</label>
                                <input type="url" class="form-control" id="editWebhookUrl">
                                <div class="form-text">URL to notify when sync completes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editEnableMapping">
                        <label class="form-check-label" for="editEnableMapping">
                            Enable this mapping
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMapping()">
                    <i class="bi bi-check-circle"></i> Update Mapping
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMappings();
    loadCalDAVAccounts();
    loadGoogleCalendars();
    
    // Setup account change handler
    document.getElementById('caldavAccount').addEventListener('change', function() {
        loadCalDAVCalendars(this.value);
    });
});

async function loadMappings() {
    const mappingsList = document.getElementById('mappings-list');
    
    try {
        const response = await fetch('/api/mappings');
        const mappings = await response.json();
        
        if (mappings.length === 0) {
            mappingsList.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">No calendar mappings configured yet.</p>
                    <p>Click "Create Mapping" to get started.</p>
                </div>
            `;
            return;
        }
        
        const mappingsHtml = mappings.map(mapping => {
            const statusBadge = mapping.enabled ? 
                '<span class="badge bg-success">Enabled</span>' : 
                '<span class="badge bg-secondary">Disabled</span>';
            
            const syncStatusBadge = mapping.last_sync_status === 'success' ? 
                '<span class="badge bg-success">Success</span>' : 
                mapping.last_sync_status === 'failure' ? 
                '<span class="badge bg-danger">Failed</span>' : 
                mapping.last_sync_status === 'running' ? 
                '<span class="badge bg-primary">Running</span>' : 
                '<span class="badge bg-secondary">Never Run</span>';
            
            const directionIcon = mapping.sync_direction === 'caldav_to_google' ? '→' :
                                 mapping.sync_direction === 'google_to_caldav' ? '←' : '↔';
            
            const lastSync = mapping.last_sync_at ? 
                new Date(mapping.last_sync_at).toLocaleString() : 'Never';
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title">
                                    ${mapping.caldav_account_name || mapping.caldav_calendar_name} ${directionIcon} ${mapping.google_calendar_name}
                                </h5>
                                <p class="card-text text-muted">
                                    Sync every ${mapping.sync_interval_minutes} minutes
                                    <br>
                                    <small>Last sync: ${lastSync}</small>
                                </p>
                            </div>
                            <div class="col-md-3">
                                ${statusBadge}
                                ${syncStatusBadge}
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="triggerSync('${mapping.id}')">
                                        <i class="bi bi-arrow-repeat"></i> Sync
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editMapping('${mapping.id}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMapping('${mapping.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        mappingsList.innerHTML = mappingsHtml;
        
    } catch (error) {
        console.error('Error loading mappings:', error);
        mappingsList.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Error loading calendar mappings. Please try again.
            </div>
        `;
    }
}

async function loadCalDAVAccounts() {
    try {
        const response = await fetch('/api/caldav/accounts');
        const accounts = await response.json();
        
        const select = document.getElementById('caldavAccount');
        select.innerHTML = '<option value="">Select an account...</option>';
        
        if (!response.ok) {
            console.error('Error loading CalDAV accounts:', accounts);
            select.innerHTML = '<option value="">Error loading accounts</option>';
            return;
        }
        
        if (!Array.isArray(accounts)) {
            console.error('Expected accounts array, got:', accounts);
            select.innerHTML = '<option value="">Error: Invalid response format</option>';
            return;
        }
        
        accounts.forEach(account => {
            if (account.enabled) {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                select.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('Error loading CalDAV accounts:', error);
    }
}

async function loadCalDAVCalendars(accountId) {
    const select = document.getElementById('caldavCalendar');
    
    if (!accountId) {
        select.innerHTML = '<option value="">Select a calendar...</option>';
        select.disabled = true;
        return;
    }
    
    try {
        select.innerHTML = '<option value="">Loading calendars...</option>';
        select.disabled = true;
        
        const response = await fetch(`/api/caldav/accounts/${accountId}/calendars`);
        const result = await response.json();
        
        select.innerHTML = '<option value="">Select a calendar...</option>';
        
        if (!response.ok) {
            console.error('Error response from calendars API:', result);
            select.innerHTML = '<option value="">Error loading calendars</option>';
            return;
        }
        
        // Check if result has calendars array (from CalendarDiscoveryResponse)
        const calendars = result.calendars || result;
        
        if (!Array.isArray(calendars)) {
            console.error('Expected calendars array, got:', calendars);
            select.innerHTML = '<option value="">Error: Invalid response format</option>';
            return;
        }
        
        calendars.forEach(calendar => {
            const option = document.createElement('option');
            option.value = calendar.id;
            option.textContent = calendar.name;
            option.dataset.name = calendar.name;
            select.appendChild(option);
        });
        
        select.disabled = false;
        
    } catch (error) {
        console.error('Error loading CalDAV calendars:', error);
        select.innerHTML = '<option value="">Error loading calendars</option>';
    }
}

async function loadGoogleCalendars() {
    try {
        const response = await fetch('/api/google/calendars');
        const result = await response.json();
        
        const select = document.getElementById('googleCalendar');
        select.innerHTML = '<option value="">Select a calendar...</option>';
        
        if (!response.ok) {
            console.error('Error loading Google calendars:', result);
            select.innerHTML = '<option value="">Google authentication required</option>';
            return;
        }
        
        // Handle different possible response formats
        const calendars = result.calendars || result.items || result;
        
        if (!Array.isArray(calendars)) {
            console.error('Expected calendars array, got:', calendars);
            select.innerHTML = '<option value="">Error: Invalid response format</option>';
            return;
        }
        
        calendars.forEach(calendar => {
            const option = document.createElement('option');
            option.value = calendar.id;
            option.textContent = calendar.summary + (calendar.primary ? ' (Primary)' : '');
            option.dataset.name = calendar.summary;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading Google calendars:', error);
        const select = document.getElementById('googleCalendar');
        select.innerHTML = '<option value="">Google authentication required</option>';
    }
}

async function createMapping() {
    const form = document.getElementById('addMappingForm');
    
    const caldavAccountId = document.getElementById('caldavAccount').value;
    const caldavCalendarId = document.getElementById('caldavCalendar').value;
    const caldavCalendarName = document.getElementById('caldavCalendar').selectedOptions[0]?.dataset.name;
    const googleCalendarId = document.getElementById('googleCalendar').value;
    const googleCalendarName = document.getElementById('googleCalendar').selectedOptions[0]?.dataset.name;
    
    if (!caldavAccountId || !caldavCalendarId || !googleCalendarId) {
        showAlert('Please select both CalDAV and Google calendars', 'error');
        return;
    }
    
    const mappingData = {
        caldav_account_id: caldavAccountId,
        caldav_calendar_id: caldavCalendarId,
        caldav_calendar_name: caldavCalendarName,
        google_calendar_id: googleCalendarId,
        google_calendar_name: googleCalendarName,
        sync_direction: document.getElementById('syncDirection').value,
        sync_interval_minutes: parseInt(document.getElementById('syncInterval').value),
        sync_window_days: parseInt(document.getElementById('syncWindow').value),
        webhook_url: document.getElementById('webhookUrl').value || null,
        enabled: document.getElementById('enableMapping').checked
    };
    
    try {
        const response = await fetch('/api/mappings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mappingData)
        });
        
        if (response.ok) {
            showAlert('Calendar mapping created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addMappingModal')).hide();
            form.reset();
            loadMappings();
        } else {
            const error = await response.json();
            showAlert(`Failed to create mapping: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error creating mapping:', error);
        showAlert('Error creating mapping: ' + error.message, 'error');
    }
}

async function triggerSync(mappingId) {
    try {
        showAlert('Triggering sync...', 'info');
        
        const response = await fetch('/api/sync/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mapping_ids: [mappingId]
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Sync triggered successfully!', 'success');
            setTimeout(loadMappings, 2000); // Refresh after 2 seconds
        } else {
            showAlert(`Failed to trigger sync: ${result.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error triggering sync:', error);
        showAlert('Error triggering sync: ' + error.message, 'error');
    }
}

async function deleteMapping(mappingId) {
    if (!confirm('Are you sure you want to delete this calendar mapping?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/mappings/${mappingId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('Calendar mapping deleted successfully!', 'success');
            loadMappings();
        } else {
            const error = await response.json();
            showAlert(`Failed to delete mapping: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error deleting mapping:', error);
        showAlert('Error deleting mapping: ' + error.message, 'error');
    }
}

async function editMapping(mappingId) {
    try {
        // Show loading state
        showAlert('Loading mapping details...', 'info');
        
        // Fetch the mapping data
        const response = await fetch(`/api/mappings/${mappingId}`);
        if (!response.ok) {
            const error = await response.json();
            showAlert(`Failed to load mapping: ${error.detail}`, 'error');
            return;
        }
        
        const mapping = await response.json();
        
        // Clear any existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Populate the edit form
        document.getElementById('editMappingId').value = mapping.id;
        document.getElementById('editCaldavAccountName').value = mapping.caldav_account_name || 'Unknown Account';
        document.getElementById('editCaldavCalendarName').value = mapping.caldav_calendar_name;
        document.getElementById('editGoogleCalendarName').value = mapping.google_calendar_name;
        document.getElementById('editSyncDirection').value = mapping.sync_direction;
        document.getElementById('editSyncInterval').value = mapping.sync_interval_minutes;
        document.getElementById('editSyncWindow').value = mapping.sync_window_days;
        document.getElementById('editWebhookUrl').value = mapping.webhook_url || '';
        document.getElementById('editEnableMapping').checked = mapping.enabled;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editMappingModal'));
        modal.show();
        
        // Reset form validation state
        const form = document.getElementById('editMappingForm');
        form.classList.remove('was-validated');
        
    } catch (error) {
        console.error('Error loading mapping for edit:', error);
        showAlert('Error loading mapping: ' + error.message, 'error');
    }
}

async function updateMapping() {
    const mappingId = document.getElementById('editMappingId').value;
    const form = document.getElementById('editMappingForm');
    const updateButton = document.querySelector('#editMappingModal .btn-primary');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        form.reportValidity();
        return;
    }
    
    const mappingData = {
        sync_direction: document.getElementById('editSyncDirection').value,
        sync_interval_minutes: parseInt(document.getElementById('editSyncInterval').value),
        sync_window_days: parseInt(document.getElementById('editSyncWindow').value),
        webhook_url: document.getElementById('editWebhookUrl').value || null,
        enabled: document.getElementById('editEnableMapping').checked
    };
    
    try {
        // Show loading state
        const originalButtonText = updateButton.innerHTML;
        updateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        updateButton.disabled = true;
        
        const response = await fetch(`/api/mappings/${mappingId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mappingData)
        });
        
        if (response.ok) {
            showAlert('Calendar mapping updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editMappingModal')).hide();
            form.reset();
            form.classList.remove('was-validated');
            loadMappings();
        } else {
            const error = await response.json();
            showAlert(`Failed to update mapping: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error updating mapping:', error);
        showAlert('Error updating mapping: ' + error.message, 'error');
    } finally {
        // Reset button state
        updateButton.innerHTML = '<i class="bi bi-check-circle"></i> Update Mapping';
        updateButton.disabled = false;
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('main.container');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
    } else {
        console.error('Could not find main container element');
        // Fallback: try to show alert in modal or use browser alert
        alert(message);
        return;
    }
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}