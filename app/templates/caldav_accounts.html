{% extends "base.html" %}

{% block title %}CalDAV Accounts - CalDAV Sync Microservice{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-server"></i> CalDAV Accounts</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                <i class="bi bi-plus-circle"></i> Add Account
            </button>
        </div>
    </div>
</div>

<!-- Accounts List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list"></i> Your CalDAV Accounts</h5>
            </div>
            <div class="card-body">
                <div id="accounts-list">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading accounts...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add CalDAV Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label for="accountName" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="accountName" name="accountName" required>
                        <div class="form-text">A friendly name for this account</div>
                    </div>
                    <div class="mb-3">
                        <label for="baseUrl" class="form-label">Server URL</label>
                        <input type="url" class="form-control" id="baseUrl" name="baseUrl" required>
                        <div class="form-text">CalDAV server URL (e.g., https://caldav.example.com/)</div>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="verifySSL" name="verifySSL" checked>
                        <label class="form-check-label" for="verifySSL">
                            Verify SSL certificates
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="testAndSaveAccount()">
                    <i class="bi bi-check-circle"></i> Test & Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit CalDAV Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <input type="hidden" id="editAccountId" name="accountId">
                    
                    <div class="mb-3">
                        <label for="editAccountName" class="form-label">Account Name</label>
                        <input type="text" class="form-control" id="editAccountName" name="accountName" required>
                        <div class="form-text">A friendly name for this account</div>
                    </div>
                    <div class="mb-3">
                        <label for="editBaseUrl" class="form-label">Server URL</label>
                        <input type="url" class="form-control" id="editBaseUrl" name="baseUrl" required>
                        <div class="form-text">CalDAV server URL (e.g., https://caldav.example.com/)</div>
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="editPassword" name="password">
                        <div class="form-text">Leave blank to keep current password</div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editVerifySSL" name="verifySSL" checked>
                        <label class="form-check-label" for="editVerifySSL">
                            Verify SSL certificates
                        </label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editEnabled" name="enabled" checked>
                        <label class="form-check-label" for="editEnabled">
                            Enable this account
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="testEditedAccount()">
                    <i class="bi bi-wifi"></i> Test Connection
                </button>
                <button type="button" class="btn btn-primary" onclick="updateAccount()">
                    <i class="bi bi-check-circle"></i> Update Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
});

async function loadAccounts() {
    const accountsList = document.getElementById('accounts-list');
    
    try {
        const response = await fetch('/api/caldav/accounts');
        const accounts = await response.json();
        
        if (accounts.length === 0) {
            accountsList.innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">No CalDAV accounts configured yet.</p>
                    <p>Click "Add Account" to get started.</p>
                </div>
            `;
            return;
        }
        
        const accountsHtml = accounts.map(account => {
            const statusBadge = account.enabled ? 
                '<span class="badge bg-success">Enabled</span>' : 
                '<span class="badge bg-secondary">Disabled</span>';
            
            const testStatus = account.last_test_success === true ? 
                '<span class="badge bg-success">Connected</span>' : 
                account.last_test_success === false ? 
                '<span class="badge bg-danger">Connection Failed</span>' : 
                '<span class="badge bg-warning">Not Tested</span>';
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title">${account.name}</h5>
                                <p class="card-text text-muted">${account.base_url}</p>
                                <small class="text-muted">Username: ${account.username}</small>
                            </div>
                            <div class="col-md-3">
                                ${statusBadge}
                                ${testStatus}
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="testAccount('${account.id}')">
                                        <i class="bi bi-wifi"></i> Test
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editAccount('${account.id}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount('${account.id}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        accountsList.innerHTML = accountsHtml;
        
    } catch (error) {
        console.error('Error loading accounts:', error);
        accountsList.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Error loading CalDAV accounts. Please try again.
            </div>
        `;
    }
}

async function testAndSaveAccount() {
    console.log('testAndSaveAccount() called');
    
    const form = document.getElementById('addAccountForm');
    if (!form) {
        console.error('Form not found!');
        showAlert('Form not found', 'error');
        return;
    }
    
    const formData = new FormData(form);
    console.log('Form data collected');
    
    const accountData = {
        name: formData.get('accountName') || document.getElementById('accountName').value,
        base_url: formData.get('baseUrl') || document.getElementById('baseUrl').value,
        username: formData.get('username') || document.getElementById('username').value,
        password: formData.get('password') || document.getElementById('password').value,
        verify_ssl: document.getElementById('verifySSL').checked
    };
    
    console.log('Account data prepared:', {
        name: accountData.name,
        base_url: accountData.base_url,
        username: accountData.username,
        password: accountData.password ? '[REDACTED]' : 'EMPTY',
        verify_ssl: accountData.verify_ssl
    });
    
    // Validate required fields
    if (!accountData.name || !accountData.base_url || !accountData.username || !accountData.password) {
        console.error('Missing required fields');
        showAlert('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        // First test the connection
        console.log('Starting connection test...');
        showAlert('Testing connection...', 'info');
        
        const testResponse = await fetch('/api/caldav/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                username: accountData.username,
                password: accountData.password,
                base_url: accountData.base_url,
                verify_ssl: accountData.verify_ssl
            })
        });
        
        const testResult = await testResponse.json();
        
        if (!testResult.success) {
            showAlert(`Connection test failed: ${testResult.error_message}`, 'error');
            return;
        }
        
        // If test successful, save the account
        const saveResponse = await fetch('/api/caldav/accounts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
        });
        
        if (saveResponse.ok) {
            showAlert('CalDAV account added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            form.reset();
            loadAccounts();
        } else {
            const error = await saveResponse.json();
            showAlert(`Failed to save account: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error adding account:', error);
        showAlert('Error adding account: ' + error.message, 'error');
    }
}

async function testAccount(accountId) {
    try {
        showAlert('Testing account connection...', 'info');
        
        const response = await fetch(`/api/caldav/accounts/${accountId}/test`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Connection test successful!', 'success');
        } else {
            showAlert(`Connection test failed: ${result.error_message}`, 'error');
        }
        
        loadAccounts(); // Refresh to show updated test status
        
    } catch (error) {
        console.error('Error testing account:', error);
        showAlert('Error testing account: ' + error.message, 'error');
    }
}

async function deleteAccount(accountId) {
    if (!confirm('Are you sure you want to delete this CalDAV account? This will also remove all associated calendar mappings.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/caldav/accounts/${accountId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showAlert('CalDAV account deleted successfully!', 'success');
            loadAccounts();
        } else {
            const error = await response.json();
            showAlert(`Failed to delete account: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error deleting account:', error);
        showAlert('Error deleting account: ' + error.message, 'error');
    }
}

async function editAccount(accountId) {
    try {
        // Show loading state
        showAlert('Loading account details...', 'info');
        
        // Fetch the account data
        const response = await fetch(`/api/caldav/accounts/${accountId}`);
        if (!response.ok) {
            const error = await response.json();
            showAlert(`Failed to load account: ${error.detail}`, 'error');
            return;
        }
        
        const account = await response.json();
        
        // Clear any existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Populate the edit form
        document.getElementById('editAccountId').value = account.id;
        document.getElementById('editAccountName').value = account.name;
        document.getElementById('editBaseUrl').value = account.base_url;
        document.getElementById('editUsername').value = account.username;
        document.getElementById('editPassword').value = ''; // Always start empty for security
        document.getElementById('editVerifySSL').checked = account.verify_ssl;
        document.getElementById('editEnabled').checked = account.enabled;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
        modal.show();
        
        // Reset form validation state
        const form = document.getElementById('editAccountForm');
        form.classList.remove('was-validated');
        
    } catch (error) {
        console.error('Error loading account for edit:', error);
        showAlert('Error loading account: ' + error.message, 'error');
    }
}

async function testEditedAccount() {
    const form = document.getElementById('editAccountForm');
    const testButton = document.querySelector('#editAccountModal .btn-outline-primary');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        form.reportValidity();
        return;
    }
    
    const accountData = {
        username: document.getElementById('editUsername').value,
        password: document.getElementById('editPassword').value,
        base_url: document.getElementById('editBaseUrl').value,
        verify_ssl: document.getElementById('editVerifySSL').checked
    };
    
    // If password is empty, we can't test the connection
    if (!accountData.password) {
        showAlert('Please enter the password to test the connection', 'error');
        return;
    }
    
    try {
        // Show loading state
        const originalButtonText = testButton.innerHTML;
        testButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
        testButton.disabled = true;
        
        const response = await fetch('/api/caldav/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Connection test successful!', 'success');
        } else {
            showAlert(`Connection test failed: ${result.error_message}`, 'error');
        }
        
    } catch (error) {
        console.error('Error testing account:', error);
        showAlert('Error testing account: ' + error.message, 'error');
    } finally {
        // Reset button state
        testButton.innerHTML = '<i class="bi bi-wifi"></i> Test Connection';
        testButton.disabled = false;
    }
}

async function updateAccount() {
    const accountId = document.getElementById('editAccountId').value;
    const form = document.getElementById('editAccountForm');
    const updateButton = document.querySelector('#editAccountModal .btn-primary');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        form.reportValidity();
        return;
    }
    
    const accountData = {
        name: document.getElementById('editAccountName').value,
        base_url: document.getElementById('editBaseUrl').value,
        username: document.getElementById('editUsername').value,
        verify_ssl: document.getElementById('editVerifySSL').checked,
        enabled: document.getElementById('editEnabled').checked
    };
    
    // Only include password if it's provided
    const password = document.getElementById('editPassword').value;
    if (password) {
        accountData.password = password;
    }
    
    try {
        // Show loading state
        const originalButtonText = updateButton.innerHTML;
        updateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        updateButton.disabled = true;
        
        const response = await fetch(`/api/caldav/accounts/${accountId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
        });
        
        if (response.ok) {
            showAlert('CalDAV account updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editAccountModal')).hide();
            form.reset();
            form.classList.remove('was-validated');
            loadAccounts();
        } else {
            const error = await response.json();
            showAlert(`Failed to update account: ${error.detail}`, 'error');
        }
        
    } catch (error) {
        console.error('Error updating account:', error);
        showAlert('Error updating account: ' + error.message, 'error');
    } finally {
        // Reset button state
        updateButton.innerHTML = '<i class="bi bi-check-circle"></i> Update Account';
        updateButton.disabled = false;
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('main.container');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
    } else {
        console.error('Could not find main container element');
        // Fallback: try to show alert in modal or use browser alert
        alert(message);
        return;
    }
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}